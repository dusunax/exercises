import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-analytics.js";
import {
  getFirestore,
  collection,
  getDocs,
  setDoc,
  getDoc,
  doc,
} from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

// ÌÖåÏä§Ìä∏ db: ~9/12 Ïù¥ÌõÑ ÏÇ≠Ï†ú
const firebaseConfig = {
  apiKey: "AIzaSyBmozSmYHUYFfS8Vio1n-l0Twqux90lLpE",
  authDomain: "group-230826.firebaseapp.com",
  projectId: "group-230826",
  storageBucket: "group-230826.appspot.com",
  messagingSenderId: "478706830624",
  appId: "1:478706830624:web:a72720b7b0569b56441b45",
  measurementId: "G-ZYBYSGJREY",
};

const QUERY_COLLECTION_ID = getIdFromString("id");

// Firebase Ï¥àÍ∏∞Ìôî
// Firestore Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const analytics = getAnalytics(app);

let groupData = await getGroup(QUERY_COLLECTION_ID);
initialize(groupData);

// -------------------------------------------------------
/** dom elements
 * - Î™®ÏûÑ Ï†ïÎ≥¥
 * - Î≤ÑÌäº
 * - Ïù∏Ìíã
 * - Î≤ÑÌäº
 * - Î™®Îã¨
 */

// Î™®ÏûÑ Ï†ïÎ≥¥
const MEETUP_ID = document.getElementById("meetup-id");
MEETUP_ID.innerText = QUERY_COLLECTION_ID;

// ASIDE
const GEUEST_ASIDE = document.getElementById("guest-aside");
const MESSAGE_ASIDE = document.getElementById("message-aside");

// Î≤ÑÌäº
const SAVE_BUTTON = document.getElementById("save-button");
const OPEN_RESULT = document.getElementById("show-result-button");
const OPEN_RATE = document.getElementById("show-rate-button");

// Î™®Îã¨
const RESULT_MODAL = document.getElementById("result-modal");
const RATE_MODAL = document.getElementById("rate-modal");

/** Ï¥àÍ∏∞Ìôî initialize
 * 1. Í∑∏Î£π Ìå®Ïπ≠
 * 2. Î©îÏãúÏßÄ Î¶¨Ïä§Ìä∏ Ï¥àÍ∏∞Ìôî
 * 3. Ï∞∏Ïó¨Ïûê Î¶¨Ïä§Ìä∏ Ï¥àÍ∏∞Ìôî
 * 4. Î™®ÏûÑ Ï†ïÎ≥¥ Ï¥àÍ∏∞Ìôî
 */
async function initialize(group) {
  try {
    initializeMessagesData(group);
    initializeMeetupData(group);
    initializeGuestsData(group);
    document.title = group.title;
  } catch (e) {
    window.location = "/024/error.html";
  }
}

async function getGroup(collectionId) {
  const col = collection(db, "groups");
  const snapshot = await getDocs(col);
  const groups = snapshot.docs.map((doc) => doc.data());

  return groups.find((e) => e.id === collectionId);
}

async function initializeMessagesData(group) {
  if (!group) return console.log("group not found");

  const MESSAGE_COUNT = document.getElementById("message-count");
  MESSAGE_COUNT.appendChild(document.createTextNode(group.count?.message));

  const MESSAGE_LIST = document.getElementById("message-list");
  MESSAGE_LIST.innerHTML = "";
  const list = group.messages;

  list?.forEach((message) => {
    setMessageList(message, MESSAGE_LIST);
  });
}

async function initializeGuestsData(group) {
  const GUEST_LIST = document.getElementById("guest-list");
  GUEST_LIST.innerHTML = "";
  const list = group.guests;

  list?.forEach((guest) => {
    setGuestList(guest, GUEST_LIST);
  });
}

async function initializeMeetupData(group) {
  const MEETUP = document.getElementById("meetup-info");
  const { map, web } = group.link;

  MEETUP.parentElement.querySelector(".title").innerHTML = group.title;
  MEETUP.querySelector(".description").innerHTML = group.description;
  MEETUP.querySelector(".place").innerHTML = group.place;

  const link = MEETUP.querySelector(".link-web");
  link.innerHTML = web;
  link.setAttribute("href", web);

  MEETUP.querySelector(".link-map").addEventListener("click", () => {
    window.open(map, "_blank");
  });
}

// ----------------------------------------------------------------
// Ïù¥Î≤§Ìä∏ Íµ¨ÎèÖ
SAVE_BUTTON.addEventListener("click", () => {
  const nameInput = MESSAGE_ASIDE.querySelector("input[name='nickname']");
  const messageInput = MESSAGE_ASIDE.querySelector("input[name='message']");

  const MESSAGE_LIST = document.getElementById("message-list");
  const MESSAGE_COUNT = document.getElementById("message-count");

  if (nameInput.value && messageInput.value) {
    const newValues = { name: nameInput.value, message: messageInput.value };
    createMessage(newValues);
    setMessageList(newValues, MESSAGE_LIST);

    messageInput.value = "";
    nameInput.value = "ÏùµÎ™Ö";

    const newCount = groupData.count.message + 1;
    MESSAGE_COUNT.textContent = newCount;
    groupData.count.message = newCount;
  }
});

function setMessageList(message, listElement) {
  const li = document.createElement("li");
  const nameSpan = document.createElement("span");
  const textSpan = document.createElement("span");

  const deleteButton = document.createElement("i");
  deleteButton.classList.add("fas");
  deleteButton.classList.add("fa-trash");
  deleteButton.classList.add("delete");

  deleteButton.addEventListener("click", () => {
    deleteMessage(message.id);
    li.remove();

    const MESSAGE_COUNT = document.getElementById("message-count");
    const newCount =
      groupData.count.message - 1 > 0 ? groupData.count.message - 1 : 0;
    MESSAGE_COUNT.textContent = newCount;
    groupData.count.message = newCount;
  });

  li.classList.add("message-item");
  nameSpan.classList.add("name");
  textSpan.classList.add("text");

  li.dataset.id = message.id;
  nameSpan.textContent = message.name;
  textSpan.textContent = message.message;

  li.appendChild(nameSpan);
  li.appendChild(textSpan);
  li.appendChild(deleteButton);
  listElement.prepend(li);
}

async function setGuestList(guest, listElement) {
  const li = document.createElement("li");
  const nameSpan = document.createElement("span");
  const prizeLeftSpan = document.createElement("span");
  const prizeRightSpan = document.createElement("span");

  li.classList.add("guest-item");

  const PRIZE = ["", "üéÅ", "üç∞", "üßÉ"];
  nameSpan.textContent = guest.filteredName;
  prizeLeftSpan.textContent = PRIZE[guest.prize];
  prizeRightSpan.textContent = PRIZE[guest.prize];

  li.appendChild(prizeLeftSpan);
  li.appendChild(nameSpan);
  li.appendChild(prizeRightSpan);
  listElement.appendChild(li);
}

// ----------------------------------------------------------------
// Type Interfaces
/**
 * Î™®ÏûÑ Meetup
 * @typedef {object} Meetup
 * @property {string} id - Î™®ÏûÑ ID
 * @property {string} title - Î™®ÏûÑ Ïù¥Î¶Ñ
 * @property {string} description
 * @property {string} place
 * @property {number} createdAt
 * @property {Message[]} messages - Ïã§Ï†ú Î©îÏãúÏßÄ ÎÇ¥Ïö©
 * @property {Guest[]} guest - Ïã§Ï†ú Î©îÏãúÏßÄ ÎÇ¥Ïö©
 * @property {object} link {web: string, map: string}
 * @property {object} count {message: number, guest: number}
 */

/**
 * Î©îÏãúÏßÄ Message
 * @typedef {object} Message
 * @property {string} id - Î©îÏãúÏßÄ ÏûëÏÑ±ÏûêÏùò ID (ÏûêÎèô ÏÉùÏÑ±)
 * @property {string} name - Î©îÏãúÏßÄ ÏûëÏÑ±ÏûêÏùò Ïù¥Î¶Ñ
 * @property {number} createdAt - Î©îÏãúÏßÄ ÏûëÏÑ± ÏãúÍ∞Ñ (ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Îì±)
 * @property {string} message - Ïã§Ï†ú Î©îÏãúÏßÄ ÎÇ¥Ïö©
 */

/**
 * Ï∞∏Ïó¨Ïûê Geust
 * @typedef {object} Guest
 * @property {string} id - Ï∞∏Ïó¨ÏûêÏùò ID
 * @property {string} name - Ï∞∏Ïó¨ÏûêÏùò Ïù¥Î¶Ñ
 * @property {number} createdAt - Ï∞∏Ïó¨Ïûê ÏûëÏÑ± ÏãúÍ∞Ñ
 * @property {number} prize - ÎãπÏ≤® Ïó¨Î∂Ä
 */

// ----------------------------------------------------------------
/** firestore Í¥ÄÎ†® Ìï®Ïàò
 * 1. ÏÉà Î©îÏãúÏßÄ ÏÉùÏÑ±
 * 2. Î©îÏãúÏßÄ ÏÇ≠Ï†ú
 * 3. ÏÉà Ï∞∏Ïó¨Ïûê Ï∂îÍ∞Ä
 */

/** 1. Î©îÏãúÏßÄ ÏÉùÏÑ±
 * @param {object} values - Message data object {name: string, text: string}
 */
async function createMessage(values) {
  const messageData = {
    id: uuid.v4(),
    createdAt: new Date().getTime(),
    ...values,
  };
  const updatedMessages = [...(groupData.messages || []), messageData];

  try {
    const groupDocRef = doc(db, "groups", groupData.id);
    const snapshot = await getDoc(groupDocRef);
    const data = snapshot.data();

    const newCount = {
      ...data.count,
      message: !data.messages?.length ? 0 + 1 : data.messages.length + 1,
    };

    await setDoc(
      groupDocRef,
      {
        messages: updatedMessages,
        count: newCount,
      },
      { merge: true }
    );

    console.log("Message successfully created and added to the group");
    return updatedMessages;
  } catch (err) {
    console.error("Error creating message:", err);
  }
}

/** 2. Î©îÏãúÏßÄ ÏÇ≠Ï†ú
 * @param {string} id - Message ID
 */
async function deleteMessage(id) {
  const confirmation = confirm("Ï†ïÎßêÎ°ú Î©îÏãúÏßÄÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?");
  if (!confirmation) {
    return;
  }

  try {
    const groupDocRef = doc(db, "groups", groupData.id);
    const snapshot = await getDoc(groupDocRef);
    const data = snapshot.data();

    const updatedMessages = (data.messages || []).filter(
      (message) => message.id !== id
    );
    const newCount = {
      ...data.count,
      message: (data.count && data.count.message) - 1 || 0,
    };

    await setDoc(
      groupDocRef,
      {
        messages: updatedMessages,
        count: newCount,
      },
      { merge: true }
    );

    console.log("Message successfully deleted from the group");
    return updatedMessages;
  } catch (err) {
    console.error("Error deleting message:", err);
  }
}

/**
 * 3. Ï∞∏Ïó¨Ïûê Î¶¨Ïä§Ìä∏ Ìå®Ïπ≠
 * @param {string} name Ïù¥Î¶Ñ
 * @param {number} prize ÎãπÏ≤®ÎÇ¥Ïö©
 */
async function addGuest(name, prize) {
  const newGuest = {
    id: uuid.v4(),
    filteredName: addStarToName(name),
    name,
    prize,
    createdAt: new Date().getTime(),
  };

  try {
    const groupDocRef = doc(db, "groups", groupData.id);
    const snapshot = await getDoc(groupDocRef);
    const data = snapshot.data();

    const updatedGuests = [...(data.guests || []), newGuest];

    await setDoc(
      groupDocRef,
      {
        guests: updatedGuests,
      },
      { merge: true }
    );

    const GUEST_LIST = document.getElementById("guest-list");
    setGuestList(newGuest, GUEST_LIST);
    groupData.guests = updatedGuests;
    GEUEST_ASIDE.querySelector('input[name="name"]').value = "";

    console.log("New guest successfully added to the group");
    return updatedGuests;
  } catch (err) {
    console.error("Error adding new guest:", err);
  }
}

// -------------------------------------------------------
// rottie Ïï†ÎãàÎ©îÏù¥ÏÖò
const starAnimationContainer = document.getElementById("star");
const starAnimation = {
  container: starAnimationContainer,
  renderer: "svg",
  loop: true,
  autoplay: true,
  path: "/024/assets/star.json",
};

const confettiAnimationContainer = document.getElementById("confetti");
const confettiAnimation = {
  container: confettiAnimationContainer,
  renderer: "svg",
  loop: false,
  autoplay: false,
  path: "/024/assets/confetti.json",
};

const star = lottie.loadAnimation(starAnimation);
const confetti = lottie.loadAnimation(confettiAnimation);

RESULT_MODAL.querySelector("button.close").addEventListener("click", () => {
  toggleModal(RESULT_MODAL);
  setTimeout(() => {
    starAnimationContainer.classList.remove("show");
    starAnimationContainer.classList.add("hidden");
  }, 0);
});
RESULT_MODAL.querySelector(".shadow").addEventListener("click", () => {
  toggleModal(RESULT_MODAL);
  setTimeout(() => {
    starAnimationContainer.classList.remove("show");
    starAnimationContainer.classList.add("hidden");
  }, 0);
});

function toggleModal(modalElement) {
  const isModalOpen = modalElement.classList.contains("show");

  if (isModalOpen) {
    modalElement.classList.remove("show");
    modalElement.classList.add("hidden");
  } else {
    modalElement.classList.remove("hidden");
    modalElement.classList.add("show");
  }
}

RATE_MODAL.querySelector(".shadow").addEventListener("click", () => {
  toggleModal(RATE_MODAL);
  setTimeout(() => {
    starAnimationContainer.classList.remove("show");
    starAnimationContainer.classList.add("hidden");
  }, 0);
});

// -------------------------------------------------------
// ÎûúÎç§ ÎΩëÍ∏∞
OPEN_RATE.addEventListener("click", () => {
  toggleModal(RATE_MODAL);
});

const prizes = [
  { rank: 1, probability: 0.15 },
  { rank: 2, probability: 0.25 },
  { rank: 3, probability: 0.5 },
];

OPEN_RESULT.addEventListener("click", () => {
  const resultName = RESULT_MODAL.querySelector(".result-content .name");
  const nameInput = GEUEST_ASIDE.querySelector("input[name='name']");
  const newName = nameInput.value;

  const isNameDuplicate = checkNameDuplicate(newName);
  if (isNameDuplicate) {
    alert("Ïù¥ÎØ∏ Îì±Î°ùÎêú Ïù¥Î¶ÑÏûÖÎãàÎã§. Îã§Î•∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
    return;
  }

  const prizeRank = randomResultHandler(newName);
  addGuest(newName, prizeRank);

  star.goToAndPlay(0);
  confetti.goToAndPlay(0);
  resultName.innerHTML = nameInput.value;

  starAnimationContainer.classList.remove("hidden");
  starAnimationContainer.classList.add("show");

  setTimeout(() => {
    toggleModal(RESULT_MODAL);
  }, 200);
});

function randomResultHandler(newName) {
  const randomValue = Math.random();
  let accumulatedProbability = 0;

  for (const prize of prizes) {
    accumulatedProbability += prize.probability;
    if (randomValue <= accumulatedProbability) {
      showResultModal(newName, prize.rank);
      return prize.rank;
    }
  }
}

function showResultModal(newName, rank) {
  const resultName = RESULT_MODAL.querySelector(".result-content .name");
  const resultTitle = RESULT_MODAL.querySelector(".result-content .title");
  const resultText = RESULT_MODAL.querySelector(".result-content .text");

  const results = [
    { title: "", text: "" },
    { title: "Ï∂ïÌïòÌï©ÎãàÎã§!", text: "1Îì±Ïóê ÎãπÏ≤®ÎêòÏÖ®ÏäµÎãàÎã§!" },
    { title: "Ï∂ïÌïòÌï©ÎãàÎã§!", text: "2Îì±Ïóê ÎãπÏ≤®ÎêòÏÖ®ÏäµÎãàÎã§!" },
    { title: "3Îì±ÏûÖÎãàÎã§", text: "Îã§Ïùå Í∏∞ÌöåÏóê Îçî Ï¢ãÏùÄ Í≤∞Í≥ºÎ•º Í∏∞ÎåÄÌï¥Ï£ºÏÑ∏Ïöî!" },
  ];

  resultName.innerText = newName;
  resultTitle.innerText = results[rank].title;
  resultText.innerText = results[rank].text;
}

// -------------------------------------------------------
// utils
function getIdFromString(str) {
  return new URLSearchParams(window.location.search).get(str);
}

function addStarToName(name) {
  const nameWithMaskedCharacter = name.split("");
  const randomIndex = Math.floor(
    Math.random() * nameWithMaskedCharacter.length
  );
  nameWithMaskedCharacter[randomIndex] = "*";

  return nameWithMaskedCharacter.join("");
}

function checkNameDuplicate(newName) {
  if (groupData.guests === undefined || groupData.guests?.length <= 0)
    return false;

  const existingNames = groupData.guests.map((guest) => guest.name);
  return existingNames.includes(newName);
}
